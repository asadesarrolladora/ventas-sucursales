<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - Sistema de Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; }
        .cart-container { height: 400px; overflow-y: auto; background: white; border-radius: 8px; }
        .product-card { cursor: pointer; transition: 0.2s; }
        .product-card:hover { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container-fluid"><span class="navbar-brand">Punto de Venta Multi-Sucursal</span></div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-7">
                <input type="text" id="busqueda" class="form-control mb-3" placeholder="Buscar producto por nombre...">
                <div id="lista-productos" class="row g-2">
                    </div>
            </div>

            <div class="col-md-5">
                <div class="card p-3 shadow-sm">
                    <h5>ðŸ›’ Carrito</h5>
                    <div class="cart-container p-2 border mb-3" id="carrito-items">
                        <p class="text-muted text-center">No hay productos seleccionados</p>
                    </div>
                    <div class="d-flex justify-content-between h4">
                        <span>Total:</span>
                        <span>$<span id="total-precio">0.00</span></span>
                    </div>
                    <button class="btn btn-primary btn-lg w-100 mt-3" onclick="finalizarVenta()">REGISTRAR VENTA</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let carrito = [];
        let productosData = [];

        // Cargar productos al iniciar
        async function cargarProductos() {
            const res = await fetch('api/productos.php');
            productosData = await res.json();
            mostrarProductos(productosData);
        }

        function mostrarProductos(lista) {
            const contenedor = document.getElementById('lista-productos');
            contenedor.innerHTML = lista.map(p => `
                <div class="col-md-6">
                    <div class="card p-2 product-card" onclick="agregarAlCarrito(${p.id_producto}, '${p.nombre}', ${p.precio_base})">
                        <strong>${p.nombre}</strong>
                        <span class="text-success">$${p.precio_base}</span>
                    </div>
                </div>
            `).join('');
        }

        function agregarAlCarrito(id, nombre, precio) {
            const existe = carrito.find(i => i.id_producto === id);
            if (existe) { existe.cantidad++; } 
            else { carrito.push({ id_producto: id, nombre, precio_unitario: precio, cantidad: 1 }); }
            renderCarrito();
        }

        function renderCarrito() {
            const div = document.getElementById('carrito-items');
            if (carrito.length === 0) { div.innerHTML = '<p class="text-center">VacÃ­o</p>'; return; }
            
            let total = 0;
            div.innerHTML = carrito.map(i => {
                total += i.precio_unitario * i.cantidad;
                return `<div class="d-flex justify-content-between border-bottom py-1">
                    <span>${i.nombre} (x${i.cantidad})</span>
                    <span>$${(i.precio_unitario * i.cantidad).toFixed(2)}</span>
                </div>`;
            }).join('');
            document.getElementById('total-precio').innerText = total.toFixed(2);
        }

        async function finalizarVenta() {
            if (carrito.length === 0) return alert("Agrega productos primero");
            
            const payload = {
                sucursal_id: 1, // Por ahora fijo, luego puede ser dinÃ¡mico
                total: parseFloat(document.getElementById('total-precio').innerText),
                productos: carrito
            };

            const res = await fetch('api/registrar_venta.php', {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(data.status === 'success') {
                alert("Venta guardada!");
                carrito = [];
                renderCarrito();
            }
        }

        cargarProductos();
    </script>
</body>
</html>