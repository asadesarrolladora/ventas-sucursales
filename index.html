<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>POS - Sistema de Ventas</title>
    <link rel="stylesheet" href="css/estilos.css">
</head>
<body>
    <header style="background: #333; color: white; padding: 15px;">
        <h2>Punto de Venta Multi-Sucursal</h2>
    </header>

    <div style="display: flex; padding: 20px; gap: 20px;">
        <div style="flex: 2;" id="contenedorProductos">
            </div>

        <div style="flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 5px;">
            <h3>ðŸ›’ Carrito</h3>
            <div id="listaCarrito">No hay productos seleccionados</div>
            <hr>
            <h4>Total: $<span id="totalVenta">0.00</span></h4>
            <button id="btnVenta" style="background: #007bff; color: white; width: 100%; padding: 15px; border: none; font-size: 18px; cursor: pointer;">REGISTRAR VENTA</button>
        </div>
    </div>

    <script>
        let carrito = [];

        // Cargar productos con validaciÃ³n de stock
        fetch('api/productos.php')
            .then(res => res.json())
            .then(productos => {
                const contenedor = document.getElementById('contenedorProductos');
                contenedor.innerHTML = productos.map(p => `
                    <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; opacity: ${p.cantidad_disponible <= 0 ? '0.5' : '1'}">
                        <strong>${p.nombre}</strong> - $${p.precio_base} <br>
                        <small>Stock: ${p.cantidad_disponible}</small> <br>
                        ${p.cantidad_disponible > 0 
                            ? `<button onclick="agregarAlCarrito(${p.id_producto}, '${p.nombre}', ${p.precio_base})">Agregar</button>`
                            : `<b style="color:red">AGOTADO</b>`
                        }
                    </div>
                `).join('');
            });

        function agregarAlCarrito(id, nombre, precio) {
            carrito.push({id, nombre, precio, cantidad: 1});
            actualizarCarrito();
        }

        function actualizarCarrito() {
            const lista = document.getElementById('listaCarrito');
            const totalTxt = document.getElementById('totalVenta');
            let total = 0;

            lista.innerHTML = carrito.map(i => {
                total += i.precio;
                return `<div>${i.nombre} - $${i.precio}</div>`;
            }).join('');
            
            totalTxt.innerText = total.toFixed(2);
        }

        document.getElementById('btnVenta').addEventListener('click', () => {
            if (carrito.length === 0) return alert("Carrito vacÃ­o");

            fetch('api/registrar_venta.php', {
                method: 'POST',
                body: JSON.stringify({ productos: carrito, total: document.getElementById('totalVenta').innerText })
            })
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success') {
                    alert("Venta registrada con Ã©xito");
                    location.reload();
                } else {
                    alert("Error: " + res.message); // AquÃ­ mostrarÃ¡ el error de "Stock insuficiente"
                }
            });
        });
    </script>
</body>
</html>